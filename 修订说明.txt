

===========================================================================================================================================================================================================
以下为国网规约设备
===========================================================================================================================================================================================================
2018.12.07修订：
1、高温计数，满平均每个探头8个就触发报警一次
2、将出厂模式擦除动态注册表改到参数写入处，必须配合温控参数V1.5版，擦除动态注册表按钮使用


2018.12.06修订：
1、判定负数时候由>0xF800改为>=0XF800;当出现F800的时候就当作负温处理成-0，不然会F800被处理成6348.8℃
2、当出现超量程范围的温度值且不在故障代码范围内的则直接丢弃不取。（考虑将85℃这个温度点直接丢弃，出现经常性的异常85，过滤系统无法过滤）
3、故障代码范围由4000-5000改为4000-4100
4、将异常数据阈值由10度改成20度
5、修改高温报警的机制为：单个探头初次出现高温立马置标志位并报警一次，后续不报，探头出现过高温的，当温度下降到58度以后将标志位清零；整个基站累计收到120个高温报警就再发一次，每个小时25分，45分检测标志位，只要由存在探头高温标志位置位的就报警一次
6、故障代码不填入正常温度结构体，直接放入后48个发送空间，若这个小时这个探头还有正常温度上来则不发送故障代码，并且将故障代码发送空间清空。

2018.12.05修订：
1、故障报由报警机制改为整点随正常温度上报

2018.11.29修订：
1、修正上传正温时小数丢失的问题，将转化float后做除法时/10改为/10.0

2018.11.28修订：
1、增加错误数据过滤程序

2018.11.21修订：
1、添加功能，每次串口操作都将动态注册表擦除干净，擦完之后串口打印擦除完成提示信息，出厂之前进行一次串口操作，可保证现场可以挂上去之后可以直接上线，发送探头数据，每20分钟一发，持续小于一个小时。
2、针对现场频繁触发新探头每5分钟一发，将出厂模式改为每20分钟一发，持续时间由2个小时改一个小时，触发后最多每次启动两次发送。动态注册时间由8小时改为2小时，离网时间保持8小时，如果出厂不进行串口操作还是会导致现场需要等待8小时所有探头离网。
3、移除探头离网作假部分，需要作假统一由上位机来做。

2018.11.16修订：
1、修改出厂模式收到新探头时五分钟一发为20分钟一发，野外环境下避免远距离探头（非属于本基站）离网又再上网导致的功耗损失

2018.11.9修订：
1、修正了召回历史数据时的错误，以当前时间来判断召回月份的天数（例如11月份召回10月份的数据，以当前时间月份来判断的话就会仅召回30天的数据（11月份为30天）），应以召回数据月份为判断。添加一个条件，若召回的是当前月的数据，则仅召回今天以前的，避免和去年的数据混在一起。每次写之前仅擦出一天的数据区域，所以会保留本月数据区域中本天之后的去年的数据

2018.11.8修订：
1、修正了GPRS_Send_WD_Data_As_JPEG参数类型不对的问题，会导致读取256位置错误，从而导致数据召测功能在召回时无数据或数据错误，将Index_SectorNo参数由U8改为U16。
2、出厂模式中：详细数据存储过程中未读取当前时间，导致存储数据时时间戳都为FF，从而导致召回时间都为FF，增加时间填入。
3、针对开启低温工作环境下（零下十几度以下），开启GPRS发送打印没问题，而关闭打印就会出现问题，两者区别在于延时。在A8500CommandP中添加低温下N485SHOWEN不启用时打印的时间换算成OSTimeDly加入延时进行实验


2018.11.6修订：
1、修改负温数据处理时的bug
    a.GPID每次上电赋初值为-55度，之后读取到数据只要大于这个值则会覆盖
    b.每个小时清除GPID结构体时赋初值为-55度，同样下个小时读取到新的数据只要大于这个值就会覆盖
    c.每次收到温度时都将其转化为浮点型进行比较，不存在正负温比较会发生错误的问题。

2018.11.5修订：
1、修正负温组包时发生的错误应&0x07ff去掉高五位即可，原本错在&0x1fff.或者0x1ff.导致负温时候数据完全错误。并且去掉没必要的-40度的卡控

2018.10.29修订：
1、针对偶发的GPRS发送时发生复位的现象，在GPRS启动过程中加上禁止进入stop模式的锁。
    优点：有效减少复位状况（待观察）；缺点：在GPRS发送过程中大约一分多钟时间内不进入低功耗，增加少量功耗。


2018.10.26修订：
1、进行ADC测量的补偿，减去一个误差平均值0.49

2018.10.19修订：
1、Hot Reset时取消485的1min等待，降低功耗。

2018.10.18修订:
1、485打印取消（除了规约中）
2、sleep mode 新的函数加入，测试通过
3、485lowpower中添加超时标志位未清零直接初始化485，485在实际正式应用中没有任何用处，这里是避免测试程序中添加的打印导致出错陷入死循环

2018.10.17修订:
1、外部RTC初始化失败导致读取时间的时间一直是错误的直到下次联网对时写入时间后才能正常。将初始化写入一个正确的时间后可使 RTC读取正确
2、sleep mode新的程序待测试


2018.10.16修订:
1、修改射频接收板连续10次命令无回复（3分钟）就给它断电强制复位（原本为60次）
    关闭RF电源时添加串口引脚低功耗配置，这样才能真正断电
2、ME909S驱动中数据召测发送数据过程，每条数据之间的间隔加上1s（由于485波特率改为38400后打印时间大大减少导致间隔不足透传会出问题）

2018.10.13修订:
1、修正主频配置中HSE打开失败后打开LSE的错误，应打开HSI，若使用HSI则主频为8M
2、因后台已修复，将整点上报改回原来的随机三分钟
3、ADC文件修改，增加了控制引脚PC12。需要检测时才使能导通，省电。

2018.09.28修订:
1、删除无关的复位打印
2、删除systick中的喂狗
3、任务看门狗超时时间改短15000->1500（约15.8分钟）

2018.09.27修订:
1、将变量MailMailWaiting改名叫StopModeLock，禁入STOP模式适用范围包括但不仅限于等待邮箱的过程。
2、取消ME909S首次打开链接前关闭所有链接（节省发送时间），首次联网本身就未打开任何链接。
3、减少GPRS联网中各种不必要的延时，
4、再次减少GPRS联网中各种不必要的查询，尽量缩短联网时间

5、修改为每次闹钟设置前都进行初值设置，应用到所有基站上进行测试观察24小时--------------------------------------->有效，可保持不复位  ???

2018.09.26修订:
1、删除RTC_WaitForLastTask()中的延时，改回原本库函数，测试复位概率是否有所降低----------------->有效，依此
2、将整点存数的过程保护起来，在存数过程中不进入低功耗，避免存数出问题（时间不长）

3、在每次设置闹钟前重新设置初值，测试对唤醒是否有所帮助 --------->有效

2018.09.25修订:
1、删除idle任务中，等待邮箱时进入睡眠模式。
2、在闹钟唤醒刚开始加上RTC_WaitForLastTask();
3、整点三分钟随机发改为固定00分时发送，后台存在问题，仅在0~3分钟内能接收数据，暂时先改这样，后续要改回来！！！！！！！！！！
4、考虑将systick中断外部看门狗喂狗添加回来，实际大部分时间休眠是关闭systick中断的，仅小部分时间有开放中断，这里喂狗的次数并不很多，但是能保证唤醒时段内都是能及时喂狗
     ------------------->直接将存数保护起来，复位与此关系不大，保持删除systick中断喂狗，产生复位的情况发生在GPRS启动联网发送过程中，唤醒休眠切换频繁，易陷入休眠后无法唤醒的状况---->与RTC闹钟有关


2018.09.21修订:
1、在设置RTC闹钟前后添加等待写操作完成，每次RTC写操作需等待3个RTC时钟（可能存在闹钟写操作未完成就进入STOP 模式，从而导致唤醒时标志位无法清除）。------------------>有效，唤醒后可直接清除标志位


2018.09.19修订: 
1、修正了BSP_RX8025Init()初始化失败会陷入死循环的bug。
2、心跳組幀時添加上讀取RTC時間（原本直接使用時間，在RTC任務中每一秒讀取一次時間）
3、在A8500COMMANDP中添加喂狗
4、将ME909S关机改回到ONOFF电平控制（指令关机若不等待关机整个过程完成，易发生复位，原因不明）---->与此无关。

2018.09.18修订: 
1、针对存数时易发生复位（将systick中断中喂狗去除之后），在W25QXX_Read和W25QXX_Write每次调用时直接喂狗一次
2、将发送温度数据时每次组帧时留出OSTIMEDLY（10）修改为（2），由于RF与GPRS任务互斥了，同时在跑的只有GPRS和WDT，喂狗不需要留那么长时间，只要喂上了就可以
3、修改ME909S驱动，去除一些不必要的查询，（应不影响联网，待观察），修改关机为指令关机，进一步缩短GPRS打开时间

2018.09.17修订: 
1、电压判断处，应是电容电压而不是电池电压小于5V时强制打开电池，已修正。
2、看门狗任务优先级提到最高后，软件复位失败问题，修正（使用系统库函数直接复位，不进行while（1）等待看门狗起作用）。
3、操作外部存储时，有时因得到不喂狗而被复位，现已在驱动中手动加入喂狗，每读写1K喂一次。if(Num%1024==0)
4、补充了RF与GPRS任务的互斥。采用挂起/恢复任务的方式。
5、修正了将任务挂起之后不进入STOP模式的问题，对于被挂起的任务（OSTCBDly=0），不查询比较OSTCBDly